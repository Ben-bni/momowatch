<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MomoWatch Transactions - View, search, filter, and manage all mobile money transactions.">
    <title>MomoWatch | Transactions</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #3a5f8a;
            --highlight-color: #28CC95;
            --text-color: #f1f1f1;
            --text-muted: #b8b8b8;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--primary-color); color: var(--text-color); min-height: 100vh; display: flex; flex-direction: column; }

        .main-header { background: var(--secondary-color); padding: 1rem 0; position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; gap: 3rem; }
        .header-logo { display: flex; align-items: center; gap: 0.75rem; }
        .header-logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-color), var(--highlight-color)); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.2rem; font-weight: 700; box-shadow: 0 3px 15px rgba(40, 204, 149, 0.3); }
        .header-logo-text { font-size: 1.5rem; font-weight: 700; background: linear-gradient(to right, #fff, #e9e9e9); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }

        .main-header nav { display: flex; gap: 2rem; align-items: center; }
        .nav-item { display: flex; align-items: center; gap: 0.5rem; color: var(--text-color); text-decoration: none; padding: 0.75rem 1.25rem; border-radius: 8px; transition: all 0.2s ease; font-weight: 500; }
        .nav-item:hover { color: var(--highlight-color); background: rgba(255, 255, 255, 0.1); }
        .nav-item.active { background: rgba(40, 204, 149, 0.2); color: var(--highlight-color); }
        .nav-item i { font-size: 1.1rem; }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; }
        .transactions-container { flex-grow: 1; padding: 2rem 0; }
        .page-title { margin-bottom: 2rem; }
        .page-title h1 { font-size: 2.5rem; font-weight: 700; background: linear-gradient(to right, #fff, #e9e9e9); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
        .page-title p { color: var(--text-muted); font-size: 1.1rem; }

        .loading-spinner { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-radius: 50%; border-top: 4px solid var(--highlight-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-message { background: rgba(220, 53, 69, 0.2); color: var(--danger-color); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center; }

        .transactions-controls { background: rgba(22, 33, 62, 0.8); backdrop-filter: blur(10px); border-radius: 15px; padding: 1.5rem 2rem; border: 1px solid rgba(255, 255, 255, 0.05); margin-bottom: 2rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between; }
        .search-bar { flex-grow: 1; max-width: 300px; position: relative; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); background-color: var(--primary-color); color: var(--text-color); font-size: 1rem; outline: none; transition: border-color 0.2s ease; }
        .search-bar input:focus { border-color: var(--highlight-color); }
        .search-bar i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .filter-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .filter-group select, .filter-group input[type="date"] { padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); background-color: var(--primary-color); color: var(--text-color); font-size: 1rem; outline: none; appearance: none; cursor: pointer; transition: border-color 0.2s ease; }
        .filter-group select:focus, .filter-group input[type="date"]:focus { border-color: var(--highlight-color); }
        .filter-group select option { background-color: var(--primary-color); color: var(--text-color); }

        .export-buttons { display: flex; gap: 1rem; }
        .export-buttons button { padding: 0.75rem 1.25rem; border-radius: 8px; border: none; background-color: var(--accent-color); color: white; font-size: 1rem; cursor: pointer; transition: background-color 0.2s ease; }
        .export-buttons button:hover { background-color: #4a7aa8; }
        .export-buttons button i { margin-right: 0.5rem; }

        .transactions-table-card { background: rgba(22, 33, 62, 0.8); backdrop-filter: blur(10px); border-radius: 15px; padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.05); overflow-x: auto; }
        .transactions-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .transactions-table th, .transactions-table td { padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .transactions-table th { color: var(--text-muted); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: color 0.2s ease; }
        .transactions-table th:hover { color: var(--highlight-color); }
        .transactions-table th i { margin-left: 0.5rem; font-size: 0.8rem; }
        .transactions-table tbody tr:last-child td { border-bottom: none; }
        .transactions-table tbody tr:hover { background-color: rgba(255, 255, 255, 0.05); }

        .status-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
        .status-success { background-color: rgba(40, 167, 69, 0.2); color: var(--success-color); }
        .status-pending { background-color: rgba(255, 193, 7, 0.2); color: var(--warning-color); }
        .status-failed, .status-blocked { background-color: rgba(220, 53, 69, 0.2); color: var(--danger-color); }

        .risk-score { font-weight: 600; }
        .risk-low { color: var(--success-color); }
        .risk-medium { color: var(--warning-color); }
        .risk-high { color: var(--danger-color); }

        .action-buttons button { background: none; border: none; color: var(--info-color); cursor: pointer; font-size: 1rem; margin-right: 0.5rem; transition: color 0.2s ease; }
        .action-buttons button:hover { color: var(--highlight-color); }

        .details-row { background-color: rgba(255, 255, 255, 0.03); }
        .details-content { padding: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem; color: var(--text-muted); }
        .details-content strong { color: var(--text-color); display: block; margin-bottom: 0.2rem; }

        .main-footer { background: var(--secondary-color); padding: 2rem 0; text-align: center; margin-top: auto; }

        @media (max-width: 1024px) { .transactions-controls { flex-direction: column; align-items: stretch; } .search-bar { max-width: 100%; } .filter-group, .export-buttons { width: 100%; justify-content: center; } }
        @media (max-width: 768px) { .header-content { flex-direction: column; gap: 1rem; } .main-header nav { flex-wrap: wrap; gap: 1rem; justify-content: center; } .nav-item { padding: 0.5rem 1rem; font-size: 0.9rem; } .page-title h1 { font-size: 2rem; } .transactions-controls { padding: 1rem; } .transactions-table th, .transactions-table td { padding: 0.75rem; font-size: 0.9rem; } }
        @media (max-width: 480px) { .container { padding: 0 1rem; } .header-logo-text { font-size: 1.3rem; } .main-header nav { flex-direction: column; gap: 0.5rem; } .transactions-table-card { padding: 1rem; } }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="header-logo">
                    <div class="header-logo-icon" style="font-size: 1rem;">MW</div>
                    <span class="header-logo-text">MomoWatch</span>
                </div>
                <nav aria-label="Main Navigation">
                    <a href="../dashboard.html" class="nav-item"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                    <a href="../livemonitor.html" class="nav-item"><i class="fas fa-bolt"></i><span>Live Monitor</span></a>
                    <a href="../manualdataentry.html" class="nav-item"><i class="fas fa-keyboard"></i><span>Manual Data Entry</span></a>
                    <a href="transactions.txt" class="nav-item active"><i class="fas fa-users"></i><span>Transactions</span></a>
                    <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a>
                </nav>
            </div>
        </div>
    </header>

    <main class="transactions-container">
        <div class="container">
            <div class="page-title">
                <h1>Transaction History</h1>
                <p>View, search, and manage all past mobile money transactions.</p>
            </div>

            <div id="errorContainer"></div>

            <div class="transactions-controls">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="transactionSearch" placeholder="Search by ID, sender, recipient...">
                </div>

                <div class="filter-group">
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="blocked">Blocked</option>                        
                    </select>                    
                    <input type="date" id="startDate">
                    <input type="date" id="endDate">
                </div>

                <div class="export-buttons">
                    <button onclick="exportTable('csv')"><i class="fas fa-file-csv"></i> Export CSV</button>
                    <button onclick="exportTable('pdf')"><i class="fas fa-file-pdf"></i> Export PDF</button>
                </div>
            </div>

            <div class="transactions-table-card">
                <div id="loadingSpinner" class="loading-spinner">
                    <div class="spinner"></div>
                </div>
                
                <table class="transactions-table" id="transactionsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th data-sort="id">Transaction ID <i class="fas fa-sort"></i></th>
                            <th>Sender Name</th>
                            <th>Recipient Name</th>
                            <th data-sort="amount">Amount <i class="fas fa-sort"></i></th>
                            <th>Type</th>
                            <th data-sort="status">Status <i class="fas fa-sort"></i></th>
                            <th>Location</th>
                            <th>Device Name</th>
                            <th>Device Type</th>
                            <th data-sort="date">Date <i class="fas fa-sort"></i></th>
                            <th data-sort="time">Time <i class="fas fa-sort"></i></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 MomoWatch. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        const supabaseUrl = "https://tnebzzkshcoplwlvaxsl.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuZWJ6emtzaGNvcGx3bHZheHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MTU1NTEsImV4cCI6MjA2OTQ5MTU1MX0.EXXMhPRU_MO1gbCdYrjNywrhThkVqbmpRqL4212_gEw";
        const supabase = createClient(supabaseUrl, supabaseKey);

        let currentTransactions = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        async function fetchTransactions() {
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('date', { ascending: false })
                    .order('time', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching transactions:', error);
                showError('Failed to load transactions. Please try again.');
                return [];
            }
        }

        function showError(message) {
            document.getElementById('errorContainer').innerHTML = `<div class="error-message">${message}</div>`;
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('transactionsTable').style.display = 'table';
        }

        function formatCurrency(amount) {
            return `GH₵${parseFloat(amount || 0).toFixed(2)}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try { return new Date(dateString).toLocaleDateString(); } 
            catch { return dateString; }
        }

        function formatTime(timeString) {
            if (!timeString) return 'N/A';
            try {
                if (timeString.includes('T')) {
                    return new Date(timeString).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }
                return timeString;
            } catch { return timeString; }
        }

        function renderTable(data) {
            const tbody = document.querySelector('#transactionsTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 2rem; color: var(--text-muted);">No transactions found</td></tr>';
                return;
            }

            data.forEach(transaction => {
    const row = document.createElement('tr');
    row.setAttribute('data-transaction-id', transaction.id);

    const statusClass = `status-${(transaction.status || 'unknown').toLowerCase()}`;

    row.innerHTML = `
        <td>${transaction.transaction_id || transaction.id}</td>
        <td>${transaction.sender_name || transaction.sender || 'N/A'}</td>
        <td>${transaction.recipient_name || transaction.recipient || 'N/A'}</td>
        <td>${formatCurrency(transaction.amount)}</td>
        <td>${transaction.type || 'N/A'}</td>
        <td><span class="status-badge ${statusClass}">
            ${(transaction.status || 'Unknown').charAt(0).toUpperCase() + (transaction.status || 'unknown').slice(1)}
        </span></td>
        <td>${transaction.location || 'N/A'}</td>
        <td>${transaction.device_name || 'N/A'}</td>
        <td>${transaction.device_type || 'N/A'}</td>
        <td>${formatDate(transaction.date)}</td>
        <td>${formatTime(transaction.time)}</td>
        <td class="action-buttons">
            <button onclick="toggleDetails('${transaction.id}')"><i class="fas fa-info-circle"></i> Details</button>
        </td>
    `;
    tbody.appendChild(row);

    const detailsRow = document.createElement('tr');
    detailsRow.classList.add('details-row');
    detailsRow.id = `details-${transaction.id}`;
    detailsRow.style.display = 'none';
    detailsRow.innerHTML = `
        <td colspan="12">
            <div class="details-content">
                <div><strong>Sender Phone:</strong> ${transaction.sender || 'N/A'}</div>
                <div><strong>Recipient Phone:</strong> ${transaction.recipient || 'N/A'}</div>
                <div><strong>Transaction Fee:</strong> ${formatCurrency(transaction.fee || 0)}</div>
                <div><strong>Description:</strong> ${transaction.description || 'N/A'}</div>
                <div><strong>Reference:</strong> ${transaction.reference || 'N/A'}</div>
            </div>
        </td>
    `;
    tbody.appendChild(detailsRow);
});

        }

        window.toggleDetails = function(transactionId) {
            const detailsRow = document.getElementById(`details-${transactionId}`);
            if (detailsRow) detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
        };

        function filterTable() {
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const filteredData = currentTransactions.filter(transaction => {
                const searchableText = Object.values(transaction).filter(v => v!=null).join(' ').toLowerCase();
                const matchesSearch = searchableText.includes(searchTerm);
                const matchesStatus = statusFilter === '' || (transaction.status || '').toLowerCase() === statusFilter.toLowerCase();

                let matchesStartDate = true, matchesEndDate = true;
                if (startDate || endDate) {
                    const possibleDateFields = ['date', 'transaction_date', 'created_date', 'timestamp'];
                    let transactionDate = null;
                    for (const field of possibleDateFields) {
                        if (transaction[field]) { transactionDate = new Date(transaction[field]); break; }
                    }
                    if (transactionDate) {
                        if (startDate) matchesStartDate = transactionDate >= new Date(startDate);
                        if (endDate) matchesEndDate = transactionDate <= new Date(endDate + 'T23:59:59');
                    }
                }

                return matchesSearch && matchesStatus && matchesStartDate && matchesEndDate;
            });

            renderTable(filteredData);
        }

        function sortTable(column) {
            if (currentSortColumn === column) currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            else { currentSortColumn = column; currentSortDirection = 'asc'; }

            const sortedData = [...currentTransactions].sort((a,b)=>{
                let aValue,bValue;
                switch(column) {
                    case 'id': aValue=a.transaction_id||a.id; bValue=b.transaction_id||b.id; break;
                    case 'amount': aValue=parseFloat(a.amount||0); bValue=parseFloat(b.amount||0); break;
                    case 'status': aValue=(a.status||''); bValue=(b.status||''); break;
                    case 'date': aValue=new Date(a.date||a.created_at||0); bValue=new Date(b.date||b.created_at||0); break;
                    case 'time': aValue=new Date(a.time||a.created_at||0); bValue=new Date(b.time||b.created_at||0); break;
                    default: aValue=''; bValue=''; break;
                }
                if (aValue < bValue) return currentSortDirection==='asc'?-1:1;
                if (aValue > bValue) return currentSortDirection==='asc'?1:-1;
                return 0;
            });

            renderTable(sortedData);
        }

        function attachEventListeners() {
            document.getElementById('transactionSearch').addEventListener('input', filterTable);
            document.getElementById('statusFilter').addEventListener('change', filterTable);
            document.getElementById('startDate').addEventListener('change', filterTable);
            document.getElementById('endDate').addEventListener('change', filterTable);

            document.querySelectorAll('.transactions-table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => sortTable(th.dataset.sort));
            });
        }

        async function initialize() {
            currentTransactions = await fetchTransactions();
            hideLoadingSpinner();
            renderTable(currentTransactions);
            attachEventListeners();
        }

        initialize();

        window.exportTable = function(format) {
            alert(`Exporting table as ${format.toUpperCase()} is not implemented yet.`);
        };
    </script>
</body>
</html>
